---
- name: Run a defined job template for creation of new OCPVirt VMs
  hosts: all
  sources:
    - name: Listen to Kafka server broker
      ansible.eda.kafka:
        topic: "{{ kafkatopic }}"
        host: "{{ kafkahostname }}"
        port: "{{ kafkaport }}"
        group_id: "{{ kafkagroupid }}"
        # Note that the following lines are insecure and should
        # not be used in a production environment
        check_hostname: false
        verify_mode: CERT_OPTIONAL
  rules:
    - name: Register and patch new VM
      condition: 
        all:
          - event.body.kubernetes.namespace_name is defined 
          - event.body.kubernetes.namespace_name == vars.vmnamespace 
          - event.body.structured.msg is defined 
          - event.body.structured.msg is search("Found PID for", ignorecase=true)
      actions:
        - run_workflow_template:
            name: "add-vm-and-patch"
            organization: "virtualization"
            extra_vars:
              hostname: event.body.name

    - name: Check Condition 1
      condition: 
        all:
          - event.body.kubernetes.namespace_name is defined 
          - event.body.kubernetes.namespace_name == vars.vmnamespace 
          - event.body.structured.msg is defined 
      actions:
        - debug:
            var: vmnamespace

    - name: Check Condition 2
      condition: 
        all:
          - event.body.kubernetes.namespace_name is defined 
          - event.body.kubernetes.namespace_name == vars.vmnamespace 
      actions:
        - debug:
            msg: "Got here!"

    - name: Check Condition 3
      condition: 
        all:
          - event.body.kubernetes.namespace_name is defined 
      actions:
        - debug:
            msg: "Got here again!"
        - debug:
            var: vmnamespace
        - debug:
            var: event.body.kubernetes.namespace_name

    - name: Fallthrough
      condition: event.meta is defined
      actions:
        - debug:
            var: event
